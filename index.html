<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Doiot-BLE ç›´é€£ FFF3ï¼ˆæ¥µç°¡ä¿éšªç‰ˆï¼‰</title>
<style>
  :root{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  body{margin:0;background:#0f172a;color:#e2e8f0;display:grid;place-items:center;min-height:100vh}
  .app{width:min(560px,92vw);padding:20px;border-radius:16px;background:#111827;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 8px;font-size:22px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  button{flex:1;padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-size:16px;color:#0f172a}
  .primary{background:#60a5fa}.ghost{background:#cbd5e1}.danger{background:#fca5a5}
  .log{margin-top:12px;height:260px;overflow:auto;background:#0b1220;border-radius:10px;padding:10px;
       font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap}
  .send{display:flex;gap:8px;margin-top:10px}
  .send input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0}
  .opts{display:flex;gap:8px;align-items:center;margin-top:8px;font-size:12px;color:#94a3b8}
  select, label{background:#0b1220;color:#e2e8f0;border:1px solid #334155;border-radius:8px;padding:6px 8px}
</style>
</head>
<body>
<div class="app">
  <h1>ğŸ‹ Doiot-BLE â†’ FFF3</h1>
  <div class="row">
    <button id="btnConnect" class="primary">é€£ç·šï¼ˆFFF0ï¼‰</button>
    <button id="btnDisconnect" class="ghost" disabled>æ–·ç·š</button>
    <button id="btnStop" class="danger">é€ STOP</button>
  </div>

  <div class="send">
    <input id="txt" placeholder="è¼¸å…¥è¦é€çš„å­—ä¸²ï¼Œä¾‹å¦‚ï¼šup / UP / V60 â€¦">
    <button id="btnSend" class="primary" style="flex:0 0 auto;">é€å‡º</button>
  </div>
  <div class="opts">
    <label>å°¾ç¢¼
      <select id="trail">
        <option value="none">ç„¡</option>
        <option value="lf">\\n</option>
        <option value="crlf">\\r\\nï¼ˆLightBlue å¸¸ç”¨ï¼‰</option>
      </select>
    </label>
    <label><input type="checkbox" id="upper"> è‡ªå‹•è½‰å¤§å¯«ï¼ˆupâ†’UPï¼‰</label>
  </div>

  <div id="status" style="margin-top:8px;color:#94a3b8">
    è«‹ç”¨ Bluefy / WebBLEï¼ˆiOSï¼‰æˆ– Chromeï¼ˆAndroidï¼‰é–‹å•Ÿã€‚æ­¤é åªé‡å° FFF3 å¯«å…¥ã€‚
  </div>
  <div id="log" class="log"></div>
</div>

<script>
(() => {
  const SVC = '0000fff0-0000-1000-8000-00805f9b34fb';
  const FFF1 = '0000fff1-0000-1000-8000-00805f9b34fb';
  const FFF3 = '0000fff3-0000-1000-8000-00805f9b34fb';

  let device=null, server=null, writer=null;

  const $ = s => document.querySelector(s);
  const setStatus = s => $('#status').innerText = s;
  const log = m => { const el=$('#log'); el.textContent += m + '\n'; el.scrollTop = el.scrollHeight; };
  const supported = ('bluetooth' in navigator);

  function hex4(u){ return (u||'').toLowerCase().match(/[0-9a-f]{4}(?=[-}]?$)/)?.[0] || u; }

  async function connect(){
    try{
      if (!supported){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚'); return; }
      setStatus('æƒæä¸­â€¦ï¼ˆåƒ…å°‹æ‰¾ FFF0ï¼‰');
      // ç”¨ filters é–æœå‹™ï¼Œæ¯” optionalServices ç©©å®šï¼›åŠ  namePrefix ç²¾ç°¡æ¸…å–®
      const options = { filters:[ {services:[SVC]}, {namePrefix:'doi'} ] };
      device = await navigator.bluetooth.requestDevice(options);
      device.addEventListener('gattserverdisconnected', onDisc);
      log(`å·²é¸å–è£ç½®ï¼š${device.name||'(æœªå‘½å)'}\nID: ${device.id}`);

      setStatus('é€£ç·šä¸­â€¦');
      server = await device.gatt.connect();

      // æ–¹æ¡ˆ Aï¼šç›´æŠ“ FFF3
      try{
        const svc = await server.getPrimaryService(SVC);
        writer = await svc.getCharacteristic(FFF3);
      }catch(e){
        // æ–¹æ¡ˆ Bï¼šå…¨é¢åˆ—èˆ‰ï¼Œå†æ‰¾ â€¦fff3
        log('âš ï¸ ç›´æ¥å–å¾— FFF3 å¤±æ•—ï¼Œæ”¹å…¨é¢åˆ—èˆ‰æœå‹™/ç‰¹å¾µ');
        const svcs = await server.getPrimaryServices();
        for (const s of svcs){
          const chars = await s.getCharacteristics();
          log(`  æœå‹™: ${s.uuid}`);
          for (const c of chars){
            log(`    ç‰¹å¾µ: ${c.uuid}`);
            if (!writer && hex4(c.uuid) === 'fff3'){ writer = c; }
          }
        }
      }

      if (!writer) throw new Error('æ‰¾ä¸åˆ° FFF3ï¼›è«‹ç¢ºèªè£ç½®ä»é€£ç·šã€æœªè¢«å…¶ä»– App ä½”ç”¨ã€‚');

      setStatus('âœ… å·²é€£ç·šï¼Œé–å®š FFF3 å¯«å…¥');
      log(`âœï¸ Writer: ${writer.uuid}`);

      $('#btnConnect').disabled = true;
      $('#btnDisconnect').disabled = false;

    }catch(e){
      log('âŒ ' + (e?.message || e));
      setStatus('é€£ç·šå¤±æ•—');
      await disconnect();
    }
  }

  function onDisc(){
    setStatus('ğŸ”Œ å·²æ–·ç·š');
    $('#btnConnect').disabled = false;
    $('#btnDisconnect').disabled = true;
    device = server = writer = null;
  }

  async function disconnect(){
    try{ if (device?.gatt?.connected) device.gatt.disconnect(); }catch(_){}
    onDisc();
  }

  function buildPayload(text){
    let t = $('#upper').checked ? String(text).toUpperCase() : String(text);
    const tr = $('#trail').value;
    if (tr === 'lf') t += '\n';
    else if (tr === 'crlf') t += '\r\n';
    return new TextEncoder().encode(t);
  }

  async function write(text){
    if (!writer){ log('âš ï¸ å°šæœªé€£ç·š'); return; }
    const data = buildPayload(text);
    let ok=false, e1=null, e2=null;
    try{ await writer.writeValueWithoutResponse(data); ok = true; }catch(e){ e1=e; }
    if (!ok){ try{ await writer.writeValue(data); ok = true; }catch(e){ e2=e; } }
    if (!ok) throw new Error('å¯«å…¥å¤±æ•—ï¼š' + (e1?.message||e1||'') + (e2?(' / '+(e2?.message||e2)):''));
    log(`â†’ ${text}  (${data.length} bytes)`);
  }

  // ç¶å®š
  $('#btnConnect').addEventListener('click', connect);
  $('#btnDisconnect').addEventListener('click', disconnect);
  $('#btnStop').addEventListener('click', ()=>write('STOP'));
  $('#btnSend').addEventListener('click', ()=>{
    const v = $('#txt').value.trim(); if (v) write(v);
  });
  $('#txt').addEventListener('keydown', e => { if (e.key === 'Enter') $('#btnSend').click(); });

  if (!supported){
    setStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothï¼›è«‹ç”¨ Bluefy / WebBLEï¼ˆiOSï¼‰æˆ– Chromeï¼ˆAndroidï¼‰ã€‚');
  }
})();
</script>
</body>
</html>
