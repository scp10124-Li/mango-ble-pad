<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BLE æœ€ç°¡é€£ç·šï¼‹è‡ªå‹•é€ up</title>
<style>
  :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
  body { margin: 0; background: #0f172a; color: #e2e8f0; display: grid; place-items: center; min-height: 100vh; }
  .app { width: min(520px, 92vw); padding: 20px; border-radius: 16px; background: #111827; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  h1 { margin: 0 0 8px; font-size: 22px; }
  .row { display: flex; gap: 12px; }
  button {
    flex: 1; padding: 12px 14px; border-radius: 12px; border: 0;
    cursor: pointer; font-size: 16px; color: #0f172a;
  }
  .primary { background: #60a5fa; }
  .ghost { background: #cbd5e1; }

  .status {
    color: #94a3b8; font-size: 14px; text-align: center;
    margin-top: 10px; padding: 10px; border-radius: 8px;
    transition: background-color 0.3s, color 0.3s;
  }
  .status.connected { background-color: #166534; color: #dcfce7; }
  .status.disconnected { background-color: #b91c1c; color: #fff; }

  .log {
    margin-top: 12px; height: 200px; overflow:auto;
    background:#0b1220; border-radius:10px; padding:10px;
    font:12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
  <div class="app">
    <h1>ğŸ”— BLE é€£ç·šæ¸¬è©¦ï¼‹è‡ªå‹•é€ up</h1>
    <div class="row">
      <button id="btnConnect" class="primary">é€£ç·š</button>
      <button id="btnDisconnect" class="ghost" disabled>æ–·ç·š</button>
    </div>
    <div id="status" class="status">å°šæœªé€£ç·š</div>
    <div id="log" class="log"></div>
  </div>

<script>
(() => {
  const SERVICE_UUID = '0000fff0-0000-1000-8000-00805f9b34fb';
  const CHAR_UUID    = '0000fff3-0000-1000-8000-00805f9b34fb';

  let device = null, server = null, writerChar = null;

  const $ = s => document.querySelector(s);
  const log = m => { const el = $('#log'); el.textContent += m + '\n'; el.scrollTop = el.scrollHeight; };
  const setStatus = (text, state='') => { const el=$('#status'); el.innerText=text; el.className='status '+state; };

  async function connect() {
    try {
      if (!('bluetooth' in navigator)) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothï¼Œè«‹ä½¿ç”¨ Bluefy æˆ– Android Chromeã€‚');
        return;
      }

      setStatus('æƒæè£ç½®ä¸­â€¦');
      device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'doi' }],
        optionalServices: [SERVICE_UUID]
      });

      log(`å·²é¸å–è£ç½®ï¼š${device.name || '(æœªå‘½å)'}\nID: ${device.id}`);
      setStatus('é€£ç·šä¸­â€¦');

      device.addEventListener('gattserverdisconnected', onDisconnected);
      server = await device.gatt.connect();

      const svc = await server.getPrimaryService(SERVICE_UUID);
      writerChar = await svc.getCharacteristic(CHAR_UUID);
      const p = writerChar.properties;
      log(`âœ… æ‰¾åˆ°ç‰¹å¾µ ${CHAR_UUID} [${p.write?'write':''}${p.write&&p.writeWithoutResponse?'/':''}${p.writeWithoutResponse?'writeWithoutResponse':''}]`);

      setStatus('âœ… å·²é€£ç·š', 'connected');
      $('#btnConnect').disabled = true;
      $('#btnDisconnect').disabled = false;

      // === è‡ªå‹•å‚³é€ "up" ===
      await send('up');
      log('ğŸš€ å·²è‡ªå‹•é€å‡º "up" çµ¦ FFF3');

    } catch (err) {
      log('âŒ ' + (err?.message || err));
      setStatus('é€£ç·šå¤±æ•—', 'disconnected');
      await disconnect();
    }
  }

  async function send(text) {
    if (!writerChar) { log('âš ï¸ å°šæœªå–å¾—ç‰¹å¾µ'); return; }
    const data = new TextEncoder().encode(String(text) + '\n');
    try {
      if (writerChar.properties.writeWithoutResponse)
        await writerChar.writeValueWithoutResponse(data);
      else
        await writerChar.writeValue(data);
    } catch (e) {
      log('âŒ å‚³é€å¤±æ•—ï¼š' + (e?.message || e));
    }
  }

  async function disconnect() {
    try { if (device?.gatt?.connected) device.gatt.disconnect(); } catch (_) {}
    onDisconnected();
  }

  function onDisconnected() {
    setStatus('ğŸ”Œ å·²æ–·ç·š', 'disconnected');
    log('ğŸ”Œ BLE å·²æ–·ç·š');
    $('#btnConnect').disabled = false;
    $('#btnDisconnect').disabled = true;
    device = server = writerChar = null;
  }

  $('#btnConnect').addEventListener('click', connect);
  $('#btnDisconnect').addEventListener('click', disconnect);
})();
</script>
</body>
</html>
