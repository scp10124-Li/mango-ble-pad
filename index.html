<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mango BLE Pad â€” FFF3 Only</title>
<style>
  :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
  body { margin:0; background:#0f172a; color:#e2e8f0; display:grid; place-items:center; min-height:100vh; }
  .app { width:min(560px,92vw); padding:20px; border-radius:16px; background:#111827; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  h1{ margin:0 0 8px; font-size:22px;}
  .row{ display:flex; gap:12px; flex-wrap:wrap; }
  button{ flex:1; padding:14px 16px; border-radius:12px; border:0; cursor:pointer; font-size:16px; color:#0f172a;}
  .primary{ background:#60a5fa;} .ghost{background:#cbd5e1;} .danger{background:#fca5a5;} .blue{background:#93c5fd;}
  .pad{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:16px;}
  .pad button{ background:#e5e7eb; }
  .muted{ color:#94a3b8; font-size:12px; margin-top:8px;}
  .log{ margin-top:16px; height:200px; overflow:auto; background:#0b1220; border-radius:10px; padding:10px;
        font:12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
  .custom{ display:flex; gap:8px; margin-top:12px;}
  .custom input{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; }
</style>
</head>
<body>
  <div class="app">
    <h1>ğŸ‹ Mango BLE Pad â€” FFF3 å–®é€šé“</h1>

    <div class="row">
      <button id="btnConnect" class="primary">é€£ç·š</button>
      <button id="btnDisconnect" class="ghost" disabled>ä¸­æ–·</button>
      <button id="btnStop" class="danger">STOP</button>
      <button id="btnBlue" class="blue">BLUE</button>
    </div>

    <div class="pad">
      <div></div>
      <button data-cmd="UP">UP â¬†</button>
      <div></div>
      <button data-cmd="LEFT">LEFT â¬…</button>
      <div></div>
      <button data-cmd="RIGHT">RIGHT â¡</button>
      <div></div>
      <button data-cmd="DOWN">DOWN â¬‡</button>
      <div></div>
    </div>

    <div class="custom">
      <input id="txt" placeholder="è‡ªè¨‚æŒ‡ä»¤ï¼ˆä¾‹å¦‚ï¼šV60ã€SRV10002000â€¦ï¼‰" />
      <button id="btnSend" class="primary" style="flex:0 0 auto;">é€å‡º</button>
    </div>

    <div id="status" class="muted" style="margin-top:10px;">è«‹ç”¨ Bluefy / WebBLE é–‹å•Ÿæœ¬é ï¼ŒæŒ‰ã€é€£ç·šã€å¾Œæ“ä½œã€‚æ­¤ç‰ˆæœ¬åƒ…ä½¿ç”¨ FFF3ï¼ˆWrite w/o Responseï¼‰ã€‚</div>
    <div id="log" class="log"></div>
  </div>

<script>
(() => {
  // ====== å›ºå®šä½¿ç”¨ Doiot-BLE çš„ FFF0 / FFF3 ======
  const SERVICE_UUID = '0000fff0-0000-1000-8000-00805f9b34fb';
  const CHR_WRITE_UUID = '0000fff3-0000-1000-8000-00805f9b34fb';  // å–®é€šé“ï¼šåªå¯« FFF3

  let device = null, server = null, writerChar = null;

  const $ = s => document.querySelector(s);
  const setStatus = s => $('#status').innerText = s;
  const log = (m) => { const el = $('#log'); el.innerText += m + '\n'; el.scrollTop = el.scrollHeight; };

  function notSupported() {
    return !('bluetooth' in navigator);
  }

  async function connect() {
    try {
      if (notSupported()) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚\nè«‹åœ¨ iPhone ä¸Šä½¿ç”¨ Bluefy / WebBLE é–‹å•Ÿæœ¬é ï¼Œæˆ–åœ¨ Android ä¸Šç”¨ Chromeã€‚');
        return;
      }

      setStatus('æƒæè£ç½®ä¸­â€¦');
      const options = {
        acceptAllDevices: true,
        optionalServices: [SERVICE_UUID]
      };
      device = await navigator.bluetooth.requestDevice(options);
      device.addEventListener('gattserverdisconnected', onDisconnected);
      log(`ğŸ”— é¸å–ï¼š${device.name || '(æœªå‘½å)'} (${device.id})`);
      setStatus(`é€£ç·šä¸­ï¼š${device.name || '(æœªå‘½å)'}`);

      server = await device.gatt.connect();
      const svc = await server.getPrimaryService(SERVICE_UUID);

      // åªå–å¾— FFF3 ä½œç‚ºå¯«å…¥ç‰¹å¾µ
      writerChar = await svc.getCharacteristic(CHR_WRITE_UUID);
      const p = writerChar.properties;
      if (!(p.write || p.writeWithoutResponse)) {
        throw new Error('FFF3 ç‰¹å¾µä¸å¯å¯«ï¼›è«‹æª¢æŸ¥æ¨¡çµ„éŸŒé«”æˆ–æ”¹ç”¨ FFF1ã€‚');
      }

      setStatus('âœ… å·²é€£ç·šï¼ˆFFF0 / FFF3ï¼‰');
      log(`âœ… Service: ${SERVICE_UUID}`);
      log(`âœï¸  Write : ${CHR_WRITE_UUID} [${p.write?'write':''}${p.write&&p.writeWithoutResponse?'/':''}${p.writeWithoutResponse?'writeWithoutResponse':''}]`);

      // UI
      $('#btnConnect').disabled = true;
      $('#btnDisconnect').disabled = true; // å¤šæ•¸ç€è¦½å™¨ä¸æ”¯æ´ä¸»å‹•æ–·ç·šå¾Œè¨˜æ†¶ï¼›ä»æä¾›æŒ‰éˆ•
      $('#btnDisconnect').disabled = false;

    } catch (err) {
      log('âŒ ' + (err?.message || err));
      setStatus('é€£ç·šå¤±æ•—');
      await disconnect();
    }
  }

  function onDisconnected() {
    setStatus('ğŸ”Œ å·²æ–·ç·š');
    $('#btnConnect').disabled = false;
    $('#btnDisconnect').disabled = true;
    device = server = writerChar = null;
  }

  async function disconnect() {
    try { if (device?.gatt?.connected) device.gatt.disconnect(); } catch(_) {}
    onDisconnected();
  }

  async function send(text) {
    if (!writerChar) { log('âš ï¸ å°šæœªé€£ç·š'); return; }
    // å‚³ç´”æ–‡å­— + æ›è¡Œï¼ˆPico ç«¯å¯ç”¨ .strip() å»å°¾ï¼‰
    const data = new TextEncoder().encode(String(text) + '\n');
    try {
      if (writerChar.properties.writeWithoutResponse) {
        await writerChar.writeValueWithoutResponse(data);
      } else {
        await writerChar.writeValue(data);
      }
      log(`â†’ ${text}`);
    } catch (e) {
      log('âŒ å‚³é€å¤±æ•—ï¼š' + (e?.message || e));
    }
  }

  // ç¶ UI
  $('#btnConnect').addEventListener('click', connect);
  $('#btnDisconnect').addEventListener('click', disconnect);
  $('#btnBlue').addEventListener('click', () => send('BLUE'));
  $('#btnStop').addEventListener('click', () => send('STOP'));
  document.querySelectorAll('[data-cmd]').forEach(b => {
    b.addEventListener('click', () => send(b.dataset.cmd));
  });
  $('#btnSend').addEventListener('click', () => {
    const v = $('#txt').value.trim();
    if (v) send(v);
  });
  $('#txt').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') $('#btnSend').click();
  });

  if (notSupported()) {
    setStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothï¼Œè«‹ç”¨ Bluefy / WebBLEï¼ˆiOSï¼‰æˆ– Chromeï¼ˆAndroidï¼‰ã€‚');
  }
})();
</script>
</body>
</html>
