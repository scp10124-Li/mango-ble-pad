<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æœ€ç°¡ç‰ˆ BLE é€£ç·šæ¸¬è©¦</title>
<style>
  :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
  body { margin: 0; background: #0f172a; color: #e2e8f0; display: grid; place-items: center; min-height: 100vh; }
  .app { width: min(520px, 92vw); padding: 20px; border-radius: 16px; background: #111827; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  h1 { margin: 0 0 8px; font-size: 22px; }
  .row { display: flex; gap: 12px; }
  button { flex: 1; padding: 12px 14px; border-radius: 12px; border: 0; cursor: pointer; font-size: 16px; color: #0f172a; }
  .primary { background: #60a5fa; } .ghost { background: #cbd5e1; }
  .muted { color:#94a3b8; font-size:12px; margin-top:8px; }
  .log { margin-top: 12px; height: 240px; overflow:auto; background:#0b1220; border-radius:10px; padding:10px;
         font: 12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
  .opt { margin-top:10px; display:flex; gap:8px; }
  .opt input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; }
</style>
</head>
<body>
  <div class="app">
    <h1>ğŸ”— æœ€ç°¡ç‰ˆ BLE é€£ç·š</h1>

    <div class="row">
      <button id="btnConnect" class="primary">é€£ç·š</button>
      <button id="btnDisconnect" class="ghost" disabled>æ–·ç·š</button>
    </div>

    <!-- å¯é¸ï¼šæŒ‡å®šä¸€å€‹ Service UUID ä»¥ä¾¿åˆ—å‡ºè©²æœå‹™çš„ç‰¹å¾µï¼ˆä¸å¡«ä¹Ÿå¯é€£ç·šï¼‰ -->
    <div class="opt">
      <input id="svc" placeholder="å¯é¸ï¼šè¼¸å…¥ Service UUIDï¼ˆä¾‹ï¼š0000fff0-0000-1000-8000-00805f9b34fbï¼‰">
      <button id="btnList" class="ghost" title="å¦‚ä¸Šæ–¹æœ‰å¡« Serviceï¼Œé»æ­¤åˆ—å‡ºç‰¹å¾µ">åˆ—å‡ºç‰¹å¾µ</button>
    </div>

    <div id="status" class="muted" style="margin-top:8px;">è«‹ä»¥ Bluefy(WebBLE) æˆ– Android Chrome åœ¨ HTTPS ç¶²ç«™é–‹å•Ÿï¼ŒæŒ‰ã€é€£ç·šã€ã€‚</div>
    <div id="log" class="log"></div>
  </div>

<script>
(() => {
  let device = null, server = null;

  const $ = s => document.querySelector(s);
  const log = m => { const el = $('#log'); el.textContent += m + '\n'; el.scrollTop = el.scrollHeight; };
  const setStatus = s => $('#status').innerText = s;
  const supported = ('bluetooth' in navigator);

  function propsToList(p){
    return ['read','write','writeWithoutResponse','notify','indicate']
      .filter(k => p[k]).join(',');
  }

  async function connect() {
    try {
      if (!supported) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚\nè«‹æ–¼ iPhone ä½¿ç”¨ Bluefy / WebBLEï¼Œæˆ– Android ä½¿ç”¨ Chromeã€‚');
        return;
      }

      // åŸºæœ¬é€£ç·šï¼šè®“ä½¿ç”¨è€…æŒ‘ä»»ä½•è£ç½®ï¼›è‹¥æƒ³ç¸®å°æ¸…å–®ï¼Œå¯æ”¹ filtersï¼ˆå¦‚ namePrefixï¼‰
      const svc = $('#svc').value.trim();
      const options = svc
        ? { acceptAllDevices: true, optionalServices: [svc] }
        : { acceptAllDevices: true };

      setStatus('æƒæè£ç½®ä¸­â€¦');
      device = await navigator.bluetooth.requestDevice(options);
      device.addEventListener('gattserverdisconnected', onDisconnected);

      log(`å·²é¸å–è£ç½®ï¼š${device.name || '(æœªå‘½å)'}\nID: ${device.id}`);
      setStatus('é€£ç·šä¸­â€¦');

      server = await device.gatt.connect();
      setStatus('âœ… å·²é€£ç·šï¼ˆåƒ…å»ºç«‹é€£ç·šï¼Œä¸è®€å¯«è³‡æ–™ï¼‰');

      $('#btnConnect').disabled = true;
      $('#btnDisconnect').disabled = false;
    } catch (err) {
      log('âŒ ' + (err?.message || err));
      setStatus('é€£ç·šå¤±æ•—');
      await disconnect();
    }
  }

  async function listCharacteristics() {
    try {
      if (!server) { log('âš ï¸ å°šæœªé€£ç·š'); return; }
      const svcUUID = $('#svc').value.trim();
      if (!svcUUID) { log('â„¹ï¸ è¦åˆ—å‡ºç‰¹å¾µï¼Œè«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥ Service UUID'); return; }

      const svc = await server.getPrimaryService(svcUUID);
      const chars = await svc.getCharacteristics();
      log(`ğŸ“¡ æœå‹™ ${svcUUID} å…±æœ‰ç‰¹å¾µ ${chars.length} å€‹ï¼š`);
      for (const c of chars) {
        log(`  â€¢ ${c.uuid}  [${propsToList(c.properties) || 'ç„¡å±¬æ€§'}]`);
      }
    } catch (e) {
      log('âŒ åˆ—å‡ºç‰¹å¾µå¤±æ•—ï¼š' + (e?.message || e));
    }
  }

  function onDisconnected() {
    setStatus('ğŸ”Œ å·²æ–·ç·š');
    $('#btnConnect').disabled = false;
    $('#btnDisconnect').disabled = true;
    device = server = null;
  }

  async function disconnect() {
    try { if (device?.gatt?.connected) device.gatt.disconnect(); } catch (_) {}
    onDisconnected();
  }

  // ç¶å®š
  $('#btnConnect').addEventListener('click', connect);
  $('#btnDisconnect').addEventListener('click', disconnect);
  $('#btnList').addEventListener('click', listCharacteristics);

  // åˆå§‹æç¤º
  if (!supported) {
    setStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothï¼›è«‹ä½¿ç”¨ Bluefy / WebBLEï¼ˆiOSï¼‰æˆ– Chromeï¼ˆAndroidï¼‰ã€‚');
  }
})();
</script>
</body>
</html>
