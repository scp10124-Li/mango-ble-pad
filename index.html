<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mango BLE Pad (Doiot-BLE / FFF0)</title>
<style>
  :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
  body { margin: 0; background: #0f172a; color: #e2e8f0; display:grid; place-items:center; min-height:100vh; }
  .app { width:min(540px,92vw); padding:20px; border-radius:16px; background:#111827; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  h1{ margin:0 0 8px; font-size:22px;}
  .row{ display:flex; gap:12px; flex-wrap:wrap; }
  button{ flex:1; padding:14px 16px; border-radius:12px; border:0; cursor:pointer; font-size:16px; color:#0f172a;}
  .primary{ background:#60a5fa;} .ghost{background:#cbd5e1;} .danger{background:#fca5a5;} .blue{background:#93c5fd;}
  .pad{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:16px;}
  .pad button{ background:#e5e7eb; }
  .muted{ color:#94a3b8; font-size:12px; margin-top:8px;}
  .log{ margin-top:16px; height:200px; overflow:auto; background:#0b1220; border-radius:10px; padding:10px;
        font:12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
</style>
</head>
<body>
  <div class="app">
    <h1>ğŸ‹ Mango BLE Pad</h1>
    <div class="row">
      <button id="btnConnect" class="primary">é€£ç·š</button>
      <button id="btnDisconnect" class="ghost">ä¸­æ–·</button>
      <button id="btnBlue" class="blue">BLUE</button>
      <button id="btnStop" class="danger">STOP</button>
    </div>

    <div class="pad">
      <div></div>
      <button data-cmd="UP">UP â¬†</button>
      <div></div>
      <button data-cmd="LEFT">LEFT â¬…</button>
      <div></div>
      <button data-cmd="RIGHT">RIGHT â¡</button>
      <div></div>
      <button data-cmd="DOWN">DOWN â¬‡</button>
      <div></div>
    </div>

    <div class="muted" id="status">è«‹ç”¨ Bluefy / WebBLE é–‹å•Ÿæœ¬é ï¼Œå†æŒ‰ã€é€£ç·šã€</div>
    <div class="log" id="log"></div>
    <div class="muted">æç¤ºï¼šæœ¬é å›ºå®šä½¿ç”¨ Doiot-BLEï¼ˆService FFF0, Write FFF3, Notify FFF1ï¼‰ã€‚</div>
  </div>

<script>
(() => {
  // === Doiot-BLEï¼ˆFFF0/FFF1/FFF3ï¼‰å›ºå®š UUID ===
  const SVC_UUID = '0000fff0-0000-1000-8000-00805f9b34fb';
  const CHR_NOTIFY_UUID = '0000fff1-0000-1000-8000-00805f9b34fb'; // TX: è£ç½®â†’æ‰‹æ©Ÿ
  const CHR_WRITE_UUID  = '0000fff3-0000-1000-8000-00805f9b34fb'; // RX: æ‰‹æ©Ÿâ†’è£ç½® (write w/o rsp)

  let device = null, server = null, writerChar = null, notifyChar = null;

  const $ = s => document.querySelector(s);
  const log = (m) => { const el = $('#log'); el.innerText += m + '\n'; el.scrollTop = el.scrollHeight; }
  const setStatus = (s) => $('#status').innerText = s;

  function toHex(dv){
    const a=[]; for(let i=0;i<dv.byteLength;i++){ a.push(('0'+dv.getUint8(i).toString(16)).slice(-2).toUpperCase()); }
    return a.join(' ');
  }

  async function connect(){
    try{
      if(!navigator.bluetooth){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚\nè«‹åœ¨ iPhone ä¸Šä½¿ç”¨ Bluefy æˆ– WebBLE é–‹å•Ÿæœ¬é ã€‚'); return; }

      setStatus('æƒæè£ç½®ä¸­â€¦');
      // Bluefy/WebBLE çš†æ”¯æ´ acceptAllDevices + optionalServices
      const options = { acceptAllDevices: true, optionalServices: [SVC_UUID] };
      // è‹¥æƒ³ç¸®å°æ¸…å–®ï¼Œå¯æ”¹ç”¨ filtersï¼š{ filters:[{services:[SVC_UUID]}, {namePrefix:'doi'}] }
      device = await navigator.bluetooth.requestDevice(options);

      log(`ğŸ”— é¸å–ï¼š${device.name || '(æœªå‘½å)'} (${device.id})`);
      setStatus(`é€£ç·šä¸­ï¼š${device.name || '(æœªå‘½å)'}`);
      device.addEventListener('gattserverdisconnected', onDisconnected);

      server = await device.gatt.connect();
      const svc = await server.getPrimaryService(SVC_UUID);

      // å–å¾—å¯å¯«ç‰¹å¾µï¼ˆFFF3ï¼‰
      writerChar = await svc.getCharacteristic(CHR_WRITE_UUID);
      const p = writerChar.properties;
      if(!(p.write || p.writeWithoutResponse)){
        throw new Error('FFF3 ç‰¹å¾µä¸å¯å¯«ï¼›è«‹å†æª¢æŸ¥æ¨¡çµ„éŸŒé«”');
      }

      // å–å¾—é€šçŸ¥ç‰¹å¾µï¼ˆFFF1ï¼Œå¯é¸ï¼‰
      try{
        notifyChar = await svc.getCharacteristic(CHR_NOTIFY_UUID);
        if (notifyChar.properties.notify || notifyChar.properties.indicate){
          await notifyChar.startNotifications();
          notifyChar.addEventListener('characteristicvaluechanged', evt=>{
            const v = evt.target.value;
            let txt=''; try{ txt = new TextDecoder().decode(v); }catch{}
            log(`â† ${toHex(v)} ${txt?`ã€Œ${txt.trim()}ã€`:''}`);
          });
        }
      }catch(_){ /* FFF1 éå¿…è¦ï¼Œç•¥é */ }

      setStatus('âœ… å·²é€£ç·šï¼ˆFFF0/FFF3ï¼‰');
      log(`âœ… Service: ${SVC_UUID}`);
      log(`âœï¸  Write : ${CHR_WRITE_UUID}  [${p.write?'write':''}${p.write&&p.writeWithoutResponse?'/':''}${p.writeWithoutResponse?'writeWithoutResponse':''}]`);
      if (notifyChar) log(`ğŸ”” Notify: ${CHR_NOTIFY_UUID}  [notify]`);

      // UI ç‹€æ…‹
      $('#btnConnect').disabled = true;
      $('#btnDisconnect').disabled = false;

    }catch(err){
      log('âŒ ' + (err && err.message ? err.message : err));
      setStatus('é€£ç·šå¤±æ•—');
      await disconnect();
    }
  }

  function onDisconnected(){
    setStatus('ğŸ”Œ å·²æ–·ç·š');
    $('#btnConnect').disabled = false;
    $('#btnDisconnect').disabled = true;
    device = server = writerChar = notifyChar = null;
  }

  async function disconnect(){
    try{ if(device?.gatt?.connected) device.gatt.disconnect(); }catch(_){}
    onDisconnected();
  }

  async function send(text){
    if(!writerChar){ log('âš ï¸ å°šæœªé€£ç·š'); return; }
    const data = new TextEncoder().encode(text + '\n'); // Pico ç«¯ä»¥ .strip() å»å°¾
    try{
      if (writerChar.properties.writeWithoutResponse){
        await writerChar.writeValueWithoutResponse(data);
      }else{
        await writerChar.writeValue(data);
      }
      log(`â†’ ${text}`);
    }catch(e){
      log('âŒ å‚³é€å¤±æ•—ï¼š' + (e.message||e));
    }
  }

  // ç¶å®š UI
  $('#btnConnect').addEventListener('click', connect);
  $('#btnDisconnect').addEventListener('click', disconnect);
  $('#btnBlue').addEventListener('click', ()=>send('BLUE'));
  $('#btnStop').addEventListener('click', ()=>send('STOP'));
  document.querySelectorAll('[data-cmd]').forEach(b=>{
    b.addEventListener('click', ()=> send(b.dataset.cmd));
  });

  // åˆå§‹ç‹€æ…‹
  $('#btnDisconnect').disabled = true;

  // è‹¥ç€è¦½å™¨æ ¹æœ¬æ²’æœ‰ Web Bluetoothï¼Œçµ¦æ˜ç¢ºæç¤º
  if (!('bluetooth' in navigator)){
    setStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothï¼Œè«‹åœ¨ iPhone ä¸Šç”¨ Bluefy / WebBLE é–‹å•Ÿã€‚');
  }
})();
</script>
</body>
</html>
