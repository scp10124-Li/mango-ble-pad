<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mango BLE â€” å››å‘æ§åˆ¶ (FFF3)</title>
<style>
  :root{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  body{margin:0;background:#0f172a;color:#e2e8f0;display:grid;place-items:center;min-height:100vh}
  .app{width:min(520px,92vw);padding:20px;border-radius:16px;background:#111827;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 10px;font-size:22px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  button{padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-size:16px;color:#0f172a}
  .primary{background:#60a5fa}.ghost{background:#cbd5e1}.danger{background:#fca5a5}
  .pad{display:grid;grid-template-columns:96px 96px 96px;gap:12px;justify-content:center;margin-top:12px}
  .pad > div{height:0}
  .pad button{background:#e5e7eb}
  .muted{color:#94a3b8;font-size:12px;margin-top:8px}
  .log{margin-top:10px;height:180px;overflow:auto;background:#0b1220;border-radius:10px;padding:10px;
       font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap}
  .opts{display:flex;gap:10px;align-items:center;margin-top:8px;font-size:12px}
  label{display:flex;gap:6px;align-items:center}
  input[type="number"]{width:70px;padding:6px 8px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e2e8f0}
</style>
</head>
<body>
<div class="app">
  <h1>ğŸ‹ Mango BLE â€” å››å‘æ§åˆ¶ (FFF3)</h1>

  <div class="row">
    <button id="btnConnect" class="primary">é€£ç·š</button>
    <button id="btnDisconnect" class="ghost" disabled>æ–·ç·š</button>
  </div>

  <!-- åå­—éµä½ˆå±€ -->
  <div class="pad">
    <div></div>
    <button data-cmd="UP">UP â¬†</button>
    <div></div>

    <button data-cmd="LEFT">LEFT â¬…</button>
    <div></div>
    <button data-cmd="RIGHT">RIGHT â¡</button>

    <div></div>
    <button data-cmd="DOWN">DOWN â¬‡</button>
    <div></div>
  </div>

  <!-- ä¿æŒé€£ç·šï¼ˆå¿ƒè·³ï¼‰ -->
  <div class="opts">
    <label><input type="checkbox" id="keep" checked> ä¿æŒé€£ç·šï¼ˆæ¯ <input type="number" id="intv" min="5" value="20"> ç§’é€ä¸€æ¬¡ PINGï¼‰</label>
  </div>

  <div id="status" class="muted">è«‹ç”¨ Bluefy / WebBLEï¼ˆiOSï¼‰æˆ– Chromeï¼ˆAndroidï¼‰é–‹å•Ÿæœ¬é ã€‚å›ºå®šä½¿ç”¨ FFF0/FFF3ã€‚</div>
  <div id="log" class="log"></div>
</div>

<script>
(() => {
  // å›ºå®š Doiot-BLE çš„ FFF0 / FFF3
  const SVC  = '0000fff0-0000-1000-8000-00805f9b34fb';
  const FFF3 = '0000fff3-0000-1000-8000-00805f9b34fb';

  let device=null, server=null, writer=null, hbTimer=null;

  const $ = s => document.querySelector(s);
  const log = m => { const el=$('#log'); el.textContent += m + '\n'; el.scrollTop = el.scrollHeight; };
  const setStatus = s => $('#status').innerText = s;
  const supported = ('bluetooth' in navigator);

  async function connect(){
    try{
      if (!supported){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚'); return; }
      setStatus('æƒæä¸­â€¦ï¼ˆé–å®š FFF0ï¼‰');
      // ç”¨ filters é–æœå‹™ï¼‹åç¨±å‰ç¶´ï¼ˆå¯è¦–éœ€è¦èª¿æ•´ï¼‰
      const options = { filters:[ {services:[SVC]}, {namePrefix:'doi'} ] };
      device = await navigator.bluetooth.requestDevice(options);
      device.addEventListener('gattserverdisconnected', onDisc);
      log(`å·²é¸å–è£ç½®ï¼š${device.name||'(æœªå‘½å)'}\nID: ${device.id}`);

      setStatus('é€£ç·šä¸­â€¦');
      server = await device.gatt.connect();

      const svc = await server.getPrimaryService(SVC);
      writer = await svc.getCharacteristic(FFF3);
      if (!writer) throw new Error('æ‰¾ä¸åˆ° FFF3 ç‰¹å¾µ');

      setStatus('âœ… å·²é€£ç·šï¼ˆFFF3 å¯å¯«ï¼‰');
      log(`âœï¸ Writer: ${writer.uuid}`);
      $('#btnConnect').disabled = true;
      $('#btnDisconnect').disabled = false;

      startHeartbeat();
    }catch(e){
      log('âŒ ' + (e?.message || e));
      setStatus('é€£ç·šå¤±æ•—');
      await disconnect();
    }
  }

  function onDisc(){
    stopHeartbeat();
    setStatus('ğŸ”Œ å·²æ–·ç·š');
    $('#btnConnect').disabled = false;
    $('#btnDisconnect').disabled = true;
    device = server = writer = null;
  }

  async function disconnect(){
    try{ if (device?.gatt?.connected) device.gatt.disconnect(); }catch(_){}
    onDisc();
  }

  // å˜—è©¦å…©ç¨®å¯«æ³•ï¼šå…ˆ w/o responseï¼Œå¤±æ•—å†ä¸€èˆ¬ write
  async function writeText(t){
    if (!writer){ log('âš ï¸ å°šæœªé€£ç·š'); return; }
    const data = new TextEncoder().encode(String(t));
    let ok=false, e1=null, e2=null;
    try{ await writer.writeValueWithoutResponse(data); ok=true; }catch(e){ e1=e; }
    if (!ok){ try{ await writer.writeValue(data); ok=true; }catch(e){ e2=e; } }
    if (!ok) throw new Error('å¯«å…¥å¤±æ•—ï¼š' + (e1?.message||e1||'') + (e2?(' / '+(e2?.message||e2)):''));
    log(`â†’ ${t}`);
  }

  function startHeartbeat(){
    stopHeartbeat();
    if (!$('#keep').checked) return;
    const sec = Math.max(5, Number($('#intv').value) || 20);
    hbTimer = setInterval(() => {
      if (writer) writeText('PING').catch(e => log('âš ï¸ å¿ƒè·³å¤±æ•—ï¼š' + (e?.message||e)));
    }, sec*1000);
  }
  function stopHeartbeat(){
    if (hbTimer){ clearInterval(hbTimer); hbTimer=null; }
  }

  // ç¶å®š
  $('#btnConnect').addEventListener('click', connect);
  $('#btnDisconnect').addEventListener('click', disconnect);
  document.querySelectorAll('[data-cmd]').forEach(b=>{
    b.addEventListener('click', ()=> writeText(b.dataset.cmd));
  });
  $('#keep').addEventListener('change', startHeartbeat);
  $('#intv').addEventListener('change', startHeartbeat);

  if (!supported){
    setStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothï¼›è«‹ç”¨ Bluefy / WebBLEï¼ˆiOSï¼‰æˆ– Chromeï¼ˆAndroidï¼‰ã€‚');
  }
})();
</script>
</body>
</html>
