<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mango BLE Pad</title>
<style>
  :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
  body { margin: 0; background: #0f172a; color: #e2e8f0; display: grid; place-items: center; min-height: 100vh; }
  .app { width: min(520px, 92vw); padding: 20px; border-radius: 16px; background: #111827; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  h1 { margin: 0 0 8px; font-size: 24px; }
  .row { display: flex; gap: 12px; flex-wrap: wrap; }
  button { flex: 1; padding: 14px 16px; border-radius: 12px; border: 0; cursor: pointer; font-size: 16px; color: #0f172a; }
  .primary { background: #60a5fa; }
  .ghost { background: #94a3b8; }
  .danger { background: #fca5a5; }
  .ok { background: #86efac; }
  .blue { background: #93c5fd; }
  .pad { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 16px; }
  .pad button { background: #e5e7eb; }
  .log { margin-top: 16px; height: 180px; overflow:auto; background:#0b1220; border-radius:10px; padding:10px; font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .muted { color:#94a3b8; font-size:12px; margin-top:8px; }
</style>
</head>
<body>
  <div class="app">
    <h1>ğŸ‹ Mango BLE Pad</h1>
    <div class="row">
      <button id="btnConnect" class="primary">é€£ç·š</button>
      <button id="btnDisconnect" class="ghost">ä¸­æ–·</button>
      <button id="btnBlue" class="blue">BLUE</button>
      <button id="btnStop" class="danger">STOP</button>
    </div>

    <div class="pad">
      <div></div>
      <button data-cmd="UP">UP â¬†</button>
      <div></div>
      <button data-cmd="LEFT">LEFT â¬…</button>
      <div></div>
      <button data-cmd="RIGHT">RIGHT â¡</button>
      <div></div>
      <button data-cmd="DOWN">DOWN â¬‡</button>
      <div></div>
    </div>

    <div class="muted" id="status">å°šæœªé€£ç·š</div>
    <div class="log" id="log"></div>
    <div class="muted">æç¤ºï¼šè‹¥ç„¡æ³•é€£ç·šï¼Œè«‹ç”¨ Android/Chrome æ¸¬è©¦ï¼Œæˆ–ç¢ºèªæ­¤é é€é HTTPS æœå‹™ã€‚</div>
  </div>

<script>
(() => {
  // ====== ä¾ä½ çš„æ¨¡çµ„èª¿æ•´ï¼ˆéœ€è¦å¯åŠ /æ”¹ UUIDï¼‰ ======
  const UART_PROFILES = [
    // HM-10 / å¸¸è¦‹ BLE UART
    { service: '0000ffe0-0000-1000-8000-00805f9b34fb', tx: null, rx: '0000ffe1-0000-1000-8000-00805f9b34fb' },
    // Nordic NUS
    { service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e', tx: '6e400003-b5a3-f393-e0a9-e50e24dcca9e', rx: '6e400002-b5a3-f393-e0a9-e50e24dcca9e' }
  ];
  // ä½ å¯ä»¥æŠŠ namePrefix æ”¹æˆ "doi" æˆ–å®Œæ•´åç¨± "doiot-BLE"
  const NAME_PREFIX = ''; // ç•™ç©ºï¼ä¸ç¯©é¸åç¨±ï¼›æˆ–è¨­ "doi"

  // ========= ç‹€æ…‹ =========
  let device = null, server = null, writerChar = null, notifyChar = null;

  const $ = s => document.querySelector(s);
  const log = (m) => { const el = $('#log'); el.innerText += m + '\n'; el.scrollTop = el.scrollHeight; }
  const setStatus = (s) => $('#status').innerText = s;

  async function connect() {
    try {
      if (!navigator.bluetooth) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚è«‹ä½¿ç”¨ Chrome (Android) æˆ–æ–°ç‰ˆ iOS Safariã€‚');
        return;
      }
      setStatus('æƒæè£ç½®ä¸­â€¦');

      // å…ˆæŠŠæ‰€æœ‰å¯èƒ½çš„ service éƒ½ä¸Ÿé€² optionalServices
      const optional = UART_PROFILES.map(p => p.service);
      const filters = NAME_PREFIX ? [{ namePrefix: NAME_PREFIX }] : undefined;

      device = await navigator.bluetooth.requestDevice({
        filters, optionalServices: optional, acceptAllDevices: !filters
      });
      setStatus(`é€£ç·š ${device.name || '(æœªå‘½å)'}â€¦`);
      log(`ğŸ”— é¸å–ï¼š${device.name} (${device.id})`);

      device.addEventListener('gattserverdisconnected', onDisconnected);
      server = await device.gatt.connect();

      // å˜—è©¦æ¯å€‹ profileï¼Œç›´åˆ°æ‰¾åˆ°å¯å¯«å…¥çš„ characteristic
      for (const prof of UART_PROFILES) {
        try {
          const svc = await server.getPrimaryService(prof.service);
          let rxCharUUID = prof.rx; // phone -> peripheral (write)
          let txCharUUID = prof.tx; // peripheral -> phone (notify/indicate)
          // æœ‰äº›æ¨¡çµ„åªæš´éœ²ä¸€å€‹ FFE1ï¼ˆåŒæ™‚æ”¯æ´ write/notifyï¼‰
          // æ‰€ä»¥æˆ‘å€‘ä¹Ÿå˜—è©¦åœ¨ service è£¡éæ­·æ‰¾æœ€åˆé©çš„ç‰¹å¾µ
          const chars = await svc.getCharacteristics();

          // æ‰¾ writeable çš„ç‰¹å¾µç•¶ writer
          writerChar = null; notifyChar = null;
          for (const c of chars) {
            const props = c.properties;
            if (!writerChar && (props.write || props.writeWithoutResponse)) writerChar = c;
            if (!notifyChar && (props.notify || props.indicate)) notifyChar = c;
          }
          // è‹¥æŒ‡å®š UUID å­˜åœ¨ï¼Œå„ªå…ˆç”¨æŒ‡å®šçš„
          if (rxCharUUID) writerChar = await svc.getCharacteristic(rxCharUUID);
          if (txCharUUID) notifyChar = await svc.getCharacteristic(txCharUUID);

          if (writerChar) {
            setStatus('å·²é€£ç·šï¼ˆæ‰¾åˆ°å¯å¯«å…¥çš„ç‰¹å¾µï¼‰');
            log(`âœ… æœå‹™ï¼š${prof.service}`);
            log(`âœï¸  Write Charï¼š${writerChar.uuid}`);
            if (notifyChar) {
              await notifyChar.startNotifications();
              notifyChar.addEventListener('characteristicvaluechanged', evt => {
                const v = evt.target.value;
                let txt = '';
                try { txt = new TextDecoder().decode(v); } catch {}
                log(`â† ${toHex(v)}  ${txt ? `ã€Œ${txt.trim()}ã€` : ''}`);
              });
              log(`ğŸ”” Notify Charï¼š${notifyChar.uuid}ï¼ˆå·²å•Ÿç”¨ï¼‰`);
            } else {
              log('â„¹ï¸ æ­¤æœå‹™æœªå•Ÿç”¨é€šçŸ¥ï¼ˆä¸å½±éŸ¿é€æŒ‡ä»¤ï¼‰ã€‚');
            }
            return; // æˆåŠŸå°±çµæŸ
          }
        } catch (e) {
          // æ›ä¸‹ä¸€å€‹ profile
        }
      }

      throw new Error('æœªç™¼ç¾å¯å¯«å…¥çš„ UART ç‰¹å¾µï¼Œè«‹ç¢ºèªæ¨¡çµ„çš„ Service/Characteristic UUIDã€‚');

    } catch (err) {
      console.error(err);
      setStatus('é€£ç·šå¤±æ•—');
      log('âŒ ' + err.message);
      await disconnect();
    }
  }

  function onDisconnected() {
    setStatus('å·²æ–·ç·š');
    log('ğŸ”Œ å·²æ–·ç·š');
    device = server = writerChar = notifyChar = null;
  }

  async function disconnect() {
    try { if (device?.gatt?.connected) device.gatt.disconnect(); } catch {}
    onDisconnected();
  }

  async function send(text) {
    if (!writerChar) { log('âš ï¸ å°šæœªé€£ç·š'); return; }
    const data = new TextEncoder().encode(text + '\n'); // ä½ çš„ Pico ç”¨ .strip() æœƒå»æ‰ \n
    try {
      const props = writerChar.properties;
      if (props.writeWithoutResponse) {
        await writerChar.writeValueWithoutResponse(data);
      } else {
        await writerChar.writeValue(data);
      }
      log(`â†’ ${text}`);
    } catch (e) {
      log('âŒ å‚³é€å¤±æ•—ï¼š' + e.message);
    }
  }

  function toHex(dv) {
    const a = [];
    for (let i = 0; i < dv.byteLength; i++) {
      a.push( ('0' + dv.getUint8(i).toString(16)).slice(-2).toUpperCase() );
    }
    return a.join(' ');
  }

  // ç¶å®š UI
  $('#btnConnect').addEventListener('click', connect);
  $('#btnDisconnect').addEventListener('click', disconnect);
  $('#btnBlue').addEventListener('click', () => send('BLUE'));
  $('#btnStop').addEventListener('click', () => send('STOP'));
  document.querySelectorAll('[data-cmd]').forEach(b => {
    b.addEventListener('click', () => send(b.dataset.cmd));
  });
})();
</script>
</body>
</html>
